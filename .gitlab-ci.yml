image: docker

services:
  - docker:dind

before_script:
  - apk add --no-cache py-pip
  - pip install docker-compose
  - docker version
  - docker-compose version

stages:
  - test
  - deploy

Unit Tests:
  stage: test
  script:
    - docker-compose run --rm web python manage.py test lists

Func Tests:
  stage: test
  script:
    - docker-compose --project-name functests --file docker-compose.test.yml build
    - docker-compose --project-name functests --file docker-compose.test.yml run testweb

Deploy Staging:
  stage: deploy
  variables:
    HEROKU_APP_NAME: minimylist-staging
    HEROKU_LOGIN: _
  script:
    - docker-compose build
    - docker image ls

    - echo $HEROKU_API_KEY | docker login --username=_ --password-stdin registry.heroku.com
    - docker build -t registry.heroku.com/$HEROKU_APP_NAME/web .
    - docker push registry.heroku.com/$HEROKU_APP_NAME/web
    - docker run --rm -e HEROKU_API_KEY=$HEROKU_API_KEY wingrunr21/alpine-heroku-cli container:release web --app $HEROKU_APP_NAME
